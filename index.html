<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clickit Chatbot Test</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0b0f14; color:#e6edf3; display:flex; justify-content:center; padding:24px; }
    .card { width: 720px; max-width: 100%; background:#111826; border:1px solid #1f2a3a; border-radius:16px; overflow:hidden; }
    header { padding:16px 18px; border-bottom:1px solid #1f2a3a; display:flex; gap:12px; align-items:center; }
    header .dot { width:10px; height:10px; border-radius:999px; background:#22c55e; }
    header h1 { font-size:16px; margin:0; font-weight:700; }
    .chat { padding:18px; height: 60vh; overflow:auto; }
    .msg { margin: 10px 0; display:flex; }
    .bubble {
      max-width: 85%;
      padding:12px 12px;
      border-radius:14px;
      line-height:1.35;
      white-space:pre-wrap;
      unicode-bidi:isolate;
    }
    .me { justify-content:flex-end; }
    .me .bubble { background:#2563eb; color:white; border-bottom-right-radius:6px; }
    .bot { justify-content:flex-start; }
    .bot .bubble { background:#0f172a; border:1px solid #1f2a3a; border-bottom-left-radius:6px; }
    .meta { opacity:.7; font-size:12px; margin-top:6px; }
    footer { border-top:1px solid #1f2a3a; padding:14px; display:flex; gap:10px; }
    input { flex:1; padding:12px 12px; border-radius:12px; border:1px solid #1f2a3a; background:#0b1220; color:#e6edf3; outline:none; }
    button { padding:12px 14px; border-radius:12px; border:1px solid #1f2a3a; background:#22c55e; color:#052e16; font-weight:800; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .row { display:flex; gap:10px; padding:0 14px 14px; }
    .row input { flex:1; }
    .hint { padding:0 18px 14px; opacity:.7; font-size:12px; }
    code { background:#0b1220; padding:2px 6px; border-radius:8px; border:1px solid #1f2a3a; }
  </style>
</head>

<body>
  <div class="card">
    <header>
      <div class="dot"></div>
      <div>
        <h1>Clickit Chatbot (local backend via ngrok)</h1>
        <div class="meta">Endpoint: <code id="ep"></code></div>
      </div>
    </header>

    <div class="hint">
      جرّب عربي/إنجليزي. البوت المفروض يرد بنفس لغة رسالتك.
    </div>

    <div class="row">
      <input id="tenantId" placeholder="tenantId (e.g. clickit)" value="clickit" />
      <input id="sessionId" placeholder="sessionId (optional)" />
    </div>

    <div class="chat" id="chat"></div>

    <footer>
      <input id="msg" placeholder="Type a message..." autocomplete="off" />
      <button id="send">Send</button>
    </footer>
  </div>

<script>
  const NGROK_BASE = "https://bubonic-unbewitchingly-sharron.ngrok-free.dev";
  const API_URL = `${NGROK_BASE}/api/v1/chat/send`;
  document.getElementById("ep").textContent = API_URL;

  const chatEl = document.getElementById("chat");
  const msgEl = document.getElementById("msg");
  const sendBtn = document.getElementById("send");
  const tenantEl = document.getElementById("tenantId");
  const sessionEl = document.getElementById("sessionId");

  function isArabic(text) {
    return /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(text);
  }

  function addMessage(role, text) {
    const wrap = document.createElement("div");
    wrap.className = "msg " + (role === "me" ? "me" : "bot");

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    const rtl = isArabic(text);
    bubble.dir = rtl ? "rtl" : "ltr";
    bubble.style.direction = rtl ? "rtl" : "ltr";
    bubble.style.textAlign = rtl ? "right" : "left";
    bubble.style.unicodeBidi = "isolate";

    wrap.appendChild(bubble);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function ensureSessionId() {
    let v = sessionEl.value.trim();
    if (!v) {
      v = "web-" + Math.random().toString(16).slice(2) + "-" + Date.now();
      sessionEl.value = v;
    }
    return v;
  }

  async function sendMessage() {
    const message = msgEl.value.trim();
    const tenantId = tenantEl.value.trim() || "clickit";
    const sessionId = ensureSessionId();

    if (!message) return;

    addMessage("me", message);
    msgEl.value = "";
    sendBtn.disabled = true;

    const payload = { tenantId, sessionId, userId: "web", message };

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "ngrok-skip-browser-warning": "true"
        },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { reply: text }; }

      if (!res.ok) {
        addMessage("bot", `HTTP ${res.status}: ${data.detail || res.statusText || text}`);
      } else {
        addMessage("bot", data.reply || "(No reply returned)");
      }
    } catch (e) {
      addMessage("bot", "Network/CORS error: " + e.message);
    } finally {
      sendBtn.disabled = false;
      msgEl.focus();
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  msgEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") sendMessage();
  });

  addMessage("bot", "Hi! Send a message to test the backend via ngrok.");
</script>
</body>
</html>
